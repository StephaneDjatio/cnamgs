{% extends 'layout2.html' %}


{% block content %}
<div class="container" style="margin-top: 20px;">
  <!-- Nav tabs -->
  <ul class="nav nav-tabs nav-justified">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#msg">Analyse graphique</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#pro">Analyse par intelligence artificielle</a>
    </li>
  </ul>

  <!-- Tab panes -->
  <div class=" card tab-content mt-3">
    <div class="tab-pane container active" id="msg">
      <div class="card mt-3">
        <div class="card-body">
          <div>
            <h5 class="card-title text-center">Evolution des paiements par secteur d'activité </h5>
          </div>
          <hr>
          <br>
          <div id="chartdiv"></div>
        </div>
      </div>
      <div class="card mt-3">
        <div class="card-body">
          <div>
            <h5 class="card-title text-center">Nombre d'entreprises par secteur d'activité </h5>
          </div>
          <div id="chartdiv2"></div>
        </div>
      </div>
    </div>
    <div class="tab-pane container fade" id="pro">This is a profile tab.</div>
  </div>
</div>


{% endblock content %}


{% block scripts %}
<script>
  let data_chart = []
  $.ajax({
       url: '{% url "get_payment_per_sector" %}',
       type: 'get',
       dataType: 'json',
       async: false,
       success: function(response){
            console.log(response)
            $.each(response, function(index, value) {
              let sector_object = {
                sector: value[1],
                amount: value[2]
              }
              data_chart.push(sector_object)
            });
       }
  });

  console.log(data_chart)

  // Create root and chart
  var root = am5.Root.new("chartdiv");

  root.setThemes([
    am5themes_Animated.new(root)
  ]);

  var chart = root.container.children.push(
    am5percent.PieChart.new(root, {
      layout: root.verticalLayout
    })
  );

  // Define data
  var data = data_chart;

  // Create series
  var series = chart.series.push(
    am5percent.PieSeries.new(root, {
      name: "Series",
      valueField: "amount",
      categoryField: "sector"
    })
  );
  series.data.setAll(data);
  series.labels.template.set("forceHidden", true);
  series.ticks.template.set("forceHidden", true);

  // Add legend
  var legend = chart.children.push(am5.Legend.new(root, {
    centerX: am5.percent(50),
    x: am5.percent(50),
    layout: am5.GridLayout.new(root, {
      maxColumns: 3,
      fixedWidthGrid: true
    })
  }));

  legend.data.setAll(series.dataItems);
</script>

<script>
  let data_barchart = []
  $.ajax({
       url: '{% url "get_contribution_payment_per_sector" %}',
       type: 'get',
       dataType: 'json',
       async: false,
       success: function(response){
            console.log(response)
            $.each(response, function(index, value) {
              let sector_object = {
                sector: value.sector_name,
                payment: value.total_payment,
                contribution: value.total_contribution
              }
              data_barchart.push(sector_object)
            });
       }
  });

  am4core.useTheme(am4themes_animated);
  am4core.useTheme(am4themes_dataviz);

  var chart = am4core.create("chartdiv2", am4charts.XYChart);

  chart.data = data_barchart

  chart.colors.step = 2;

  var categoryAxis = chart.xAxes.push(new am4charts.CategoryAxis());
  categoryAxis.dataFields.category = "sector";
  categoryAxis.renderer.grid.template.location = 0;
  categoryAxis.renderer.line.strokeOpacity = 1;
  categoryAxis.renderer.minGridDistance = 30;

  categoryAxis.renderer.cellStartLocation = 0.2;
  categoryAxis.renderer.cellEndLocation = 0.8;

  var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

  var series1 = chart.series.push(new am4charts.ColumnSeries());
  series1.columns.template.width = am4core.percent(100);
  series1.columns.template.tooltipText = "{name}: {valueY.value}";
  series1.columns.template.strokeWidth = 0;
  series1.name = "Paiements";
  series1.dataFields.categoryX = "sector";
  series1.dataFields.valueY = "payment";

  var series2 = chart.series.push(new am4charts.ColumnSeries());
  series2.columns.template.width = am4core.percent(100);
  series2.columns.template.tooltipText = "{name}: {valueY.value}";
  series2.columns.template.strokeWidth = 0;
  series2.name = "Cotisations";
  series2.dataFields.categoryX = "sector";
  series2.dataFields.valueY = "contribution";
</script>
{% endblock scripts %}

